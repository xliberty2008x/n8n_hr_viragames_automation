{
    "nodes": [
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "2584769a-b279-40b5-8890-5afeefc9cda3",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          -912,
          -304
        ],
        "id": "6feff195-2b6b-4f24-aea6-43e162b16f3b",
        "name": "Webhook",
        "webhookId": "2584769a-b279-40b5-8890-5afeefc9cda3"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "00b14fb1-bb49-4d00-8b4c-42ce4a729186",
                "leftValue": "={{ $json.body.event_name }}",
                "rightValue": "job_application.update",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "name": "filter.operator.equals"
                }
              },
              {
                "id": "a3148a80-e90b-411b-b56a-61b1ba84d3a4",
                "leftValue": "={{ $json.body.stage_name }}",
                "rightValue": "Hired",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "name": "filter.operator.equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          -624,
          -304
        ],
        "id": "391becbd-739a-4728-addb-b6c3aea490c3",
        "name": "Hired"
      },
      {
        "parameters": {
          "jsCode": "// Fetch all job offers with pagination handling\nconst apiToken = 'rddtbCpJh6CBefTGkNTalKDdLOaVyVQ-3m86RcU7'; // From config.env\nconst baseUrl = 'https://api.teamtailor.com/v1/job-offers';\nconst pageSize = 30; // Maximum allowed by TeamTailor API\n\nlet allOffers = [];\nlet nextUrl = `${baseUrl}?include=job-application,user&page[size]=${pageSize}`;\nlet pageCount = 0;\nconst maxPages = 50; // Safety limit to prevent infinite loops\n\nconsole.log('Starting to fetch job offers with pagination...');\n\nwhile (nextUrl && pageCount < maxPages) {\n  try {\n    // Make HTTP request with proper headers\n    const response = await this.helpers.httpRequest({\n      method: 'GET',\n      url: nextUrl,\n      headers: {\n        'Authorization': `Bearer ${apiToken}`,\n        'X-Api-Version': '20240404',\n        'Accept': 'application/vnd.api+json',\n        'Content-Type': 'application/vnd.api+json'\n      },\n      json: true\n    });\n    \n    pageCount++;\n    console.log(`Fetched page ${pageCount}, got ${response.data?.length || 0} offers`);\n    \n    // Add offers from this page\n    if (response.data && Array.isArray(response.data)) {\n      allOffers = allOffers.concat(response.data);\n    }\n    \n    // Check for next page\n    nextUrl = response.links?.next || null;\n    \n    // Log pagination info\n    if (response.meta) {\n      console.log(`Total records: ${response.meta['record-count']}, Total pages: ${response.meta['page-count']}`);\n    }\n    \n  } catch (error) {\n    console.error(`Error fetching page ${pageCount + 1}:`, error.message);\n    console.error('Full error details:', error);\n    throw error;\n  }\n}\n\nconsole.log(`Pagination complete. Fetched ${pageCount} pages with total ${allOffers.length} offers`);\n\n// Return all offers as a single item with data array\nreturn [{\n  json: {\n    data: allOffers,\n    meta: {\n      totalOffers: allOffers.length,\n      pagesProcessed: pageCount\n    }\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -288,
          -576
        ],
        "id": "9607f239-e62c-4963-b855-2b7ebd0d5be8",
        "name": "Fetch All Job Offers (Paginated)"
      },
      {
        "parameters": {
          "jsCode": "// Find offer for this application\nconst webhook = $('Webhook').first().json.body;\nconst applicationId = String(webhook.id); // Ensure it's a string\nconst offersResponse = $input.all()[0].json;\n\nconsole.log('Looking for application ID:', applicationId);\nconsole.log('Total offers received:', offersResponse.data?.length || 0);\n\nlet matchingOffer = null;\nlet debugInfo = [];\n\n// Search in data array (already parsed from paginated fetch)\nif (offersResponse && offersResponse.data && Array.isArray(offersResponse.data)) {\n  console.log('Searching through offers...');\n  \n  for (const offer of offersResponse.data) {\n    const jobAppData = offer.relationships?.['job-application']?.data;\n    if (jobAppData) {\n      const offerId = String(jobAppData.id);\n      debugInfo.push({\n        offerId: offer.id,\n        jobApplicationId: offerId,\n        matches: offerId === applicationId\n      });\n      \n      if (offerId === applicationId) {\n        matchingOffer = offer;\n        console.log('Found matching offer:', offer.id);\n        break;\n      }\n    }\n  }\n} else {\n  console.log('No offers data array found');\n}\n\nconsole.log('Debug info (first 10):', JSON.stringify(debugInfo.slice(0, 10), null, 2));\n\n// If we found a matching offer, extract key data\nif (matchingOffer) {\n  const offerDetails = matchingOffer.attributes.details || {};\n  \n  return [{\n    json: {\n      found: true,\n      offerId: matchingOffer.id,\n      status: matchingOffer.attributes.status,\n      details: offerDetails,\n      salary: offerDetails.salary || offerDetails.Compensation,\n      startDate: offerDetails['Start day'] || offerDetails['start-date'],\n      applicationId: applicationId,\n      offerData: matchingOffer,\n      debugInfo: debugInfo.slice(0, 10), // Limit debug info size\n      totalOffersSearched: offersResponse.data.length,\n      pagesProcessed: offersResponse.meta?.pagesProcessed || 1\n    }\n  }];\n} else {\n  // No offer found - use default values\n  return [{\n    json: {\n      found: false,\n      applicationId: applicationId,\n      salary: null,\n      startDate: null,\n      message: \"No offer found for this application\",\n      debugInfo: debugInfo.slice(0, 10),\n      totalOffersSearched: offersResponse.data?.length || 0,\n      pagesProcessed: offersResponse.meta?.pagesProcessed || 0\n    }\n  }];\n}"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -80,
          -576
        ],
        "id": "04f7d047-8d44-4b18-8a85-193eaf6c9767",
        "name": "Process Job Offers"
      },
      {
        "parameters": {
          "jsCode": "const items = $input.all();\nconst parsedItems = items.map((item) => {\n  const parsedData = JSON.parse(item?.json?.data);\n  return { json: parsedData };\n});\nreturn parsedItems;\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          336,
          -416
        ],
        "id": "586993cc-1292-4b50-9641-dee846cc70db",
        "name": "convert to json object"
      },
      {
        "parameters": {
          "url": "={{ $json.url }}",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "X-Api-Version",
                "value": "20240404"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          112,
          -416
        ],
        "id": "918355b8-56c7-4ade-9195-7212b3cf7de3",
        "name": "HTTP Request",
        "credentials": {
          "httpBearerAuth": {
            "id": "JNoBFOypI7HysyPY",
            "name": "TeamTailor"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// 1) Збираємо всі вхідні items\nconst items = $input.all();\n\n// 2) Парсимо requisition і віддаємо тільки department URL + сам об'єкт requisition\nconst out = [];\n\nfor (const item of items) {\n  let envelope = item?.json?.data;\n\n  // data може бути рядком або вже об'єктом\n  if (typeof envelope === 'string') {\n    try {\n      envelope = JSON.parse(envelope);          // -> { data: {...} }\n    } catch (e) {\n      throw new Error(`Invalid requisition JSON: ${e.message}`);\n    }\n  }\n\n  const requisition = envelope?.data ?? envelope;\n  if (!requisition || typeof requisition !== 'object') continue;\n\n  const deptUrl = requisition?.relationships?.department?.links?.related;\n  if (!deptUrl) continue; // якщо немає URL — нічого не віддаємо\n\n  out.push({\n    json: {\n      key: 'department',\n      url: deptUrl,\n      jobId: requisition.id ?? null,\n      requisitionData: requisition, // передаємо далі по потоку\n    },\n  });\n}\n\nreturn out;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -80,
          -416
        ],
        "id": "ebad0676-e151-4c6e-8c5e-e9e1b134c5bd",
        "name": "convert to json object1"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          -288,
          -176
        ],
        "id": "b19e9391-bfbf-446b-b2b1-8b72f40040b0",
        "name": "No Operation, do nothing"
      },
      {
        "parameters": {
          "jsCode": "/**\n * Build final employee payload with job offer data.\n * Enhanced version that uses offer data for salary and start date\n */\n\n// helpers\nconst toYmd = (d) => {\n  const y = d.getFullYear();\n  const m = String(d.getMonth() + 1).padStart(2, '0');\n  const day = String(d.getDate()).padStart(2, '0');\n  return `${y}-${m}-${day}`;\n};\n\n// Parse salary to extract numeric value and pay period\nconst parseSalaryInfo = (salaryStr) => {\n  if (!salaryStr) return { amount: null, payPer: null };\n  \n  // If it's already a number, assume yearly\n  if (typeof salaryStr === 'number') {\n    return { amount: salaryStr, payPer: 'Year' };\n  }\n  \n  // Parse strings like \"1500 USD/monthly\" or \"50000 USD/yearly\"\n  const salaryString = salaryStr.toString();\n  const amountMatch = salaryString.match(/[\\d,]+/);\n  const amount = amountMatch ? parseInt(amountMatch[0].replace(/,/g, '')) : null;\n  \n  // Determine pay period\n  let payPer = 'Year'; // Default\n  if (salaryString.toLowerCase().includes('month')) {\n    payPer = 'Month';\n  } else if (salaryString.toLowerCase().includes('week')) {\n    payPer = 'Week';\n  } else if (salaryString.toLowerCase().includes('hour')) {\n    payPer = 'Hour';\n  } else if (salaryString.toLowerCase().includes('day')) {\n    payPer = 'Day';\n  }\n  \n  return { amount, payPer };\n};\n\n// sources\nconst deptItems = $input.all(); // parsed department responses\nconst webhook   = $('Webhook').first().json.body;\nconst offerData = $('Process Job Offers').first().json;\n\n// requisition: read directly from HTTP node\nlet reqEnv = null;\ntry {\n  const raw = $('HTTP Request to TeamTailor Show the Job Requisition').first().json.data;\n  if (typeof raw === 'string') reqEnv = JSON.parse(raw);\n  else if (raw && typeof raw === 'object') reqEnv = raw;\n} catch (e) {\n  console.warn('Requisition parse failed:', e.message);\n}\nconst requisition = reqEnv?.data ?? null;\nconst reqAttrs   = requisition?.attributes ?? {};\nconst cfa        = reqAttrs['custom-form-answers'] ?? {};\n\n// department name from input items\nlet departmentName = null;\nfor (const it of deptItems) {\n  const j = it.json;\n  if (j?.data?.type === 'departments' && j.data?.attributes?.name) {\n    departmentName = j.data.attributes.name; break;\n  }\n  if (j?.type === 'departments' && j?.attributes?.name) {\n    departmentName = j.attributes.name; break;\n  }\n}\n\n// team/division & level\nconst teamName       = cfa.team ?? null;\nconst candidateLevel = cfa.level_of_candidate ?? null;\nconst reqTitle       = reqAttrs['job-title'] ?? null;\n\n// job title with level prefix\nlet jobTitle = webhook.job_title || reqTitle || null;\nif (candidateLevel && jobTitle) jobTitle = `${candidateLevel} ${jobTitle}`.trim();\n\n// Use offer start date if available, otherwise fall back to updated_at\nlet hireDate = null;\nif (offerData.found && offerData.startDate) {\n  // Use start date from offer\n  hireDate = offerData.startDate;\n} else {\n  // Fallback to candidate/webhook updated_at\n  const updCandidate = webhook?.candidate?.updated_at;\n  const updWebhook   = webhook?.updated_at;\n  \n  if (updCandidate)      hireDate = toYmd(new Date(updCandidate));\n  else if (updWebhook)   hireDate = toYmd(new Date(updWebhook));\n  else                   hireDate = toYmd(new Date());\n}\n\n// Extract salary and pay period from offer if available\nlet salaryInfo = { amount: null, payPer: null };\nif (offerData.found && offerData.salary) {\n  salaryInfo = parseSalaryInfo(offerData.salary);\n}\n\n// candidate basics\nconst cand = webhook.candidate || {};\nconst employee = {\n  firstName: cand.first_name || null,\n  lastName : cand.last_name  || null,\n  jobTitle,\n  hireDate,\n  email    : cand.email || null,\n  // Add salary and pay period if available from offer\n  salary   : salaryInfo.amount,\n  payPer   : salaryInfo.payPer,\n  // Employment status based on offer status\n  employmentStatus: (offerData.found && offerData.status === 'accepted') ? 'Active' : 'Pending',\n  // Add offer tracking\n  offerStatus: offerData.status || 'no_offer',\n  offerId: offerData.offerId || null\n};\n\nif (departmentName) employee.department = departmentName;\nif (teamName)       employee.division   = teamName;\nif (cand.phone)     employee.phone      = cand.phone;\n\n// Add debugging info\nconsole.log('Offer Data:', offerData);\nconsole.log('Salary Info:', salaryInfo);\nconsole.log('Employee Payload:', employee);\n\nreturn [{ json: employee }];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          528,
          -416
        ],
        "id": "6f0c4f58-3c6e-4433-9398-753e4dc235d6",
        "name": "Build Employee Payload"
      },
      {
        "parameters": {
          "url": "=https://api.teamtailor.com/v1/jobs/{{ $json.body.job_id }}/requisition",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "X-Api-Version",
                "value": "20240404"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          -288,
          -416
        ],
        "id": "c7c2a62f-70c4-4295-a377-af213eae5364",
        "name": "HTTP Request to TeamTailor Show the Job Requisition",
        "credentials": {
          "httpBearerAuth": {
            "id": "JNoBFOypI7HysyPY",
            "name": "TeamTailor"
          }
        }
      },
      {
        "parameters": {
          "fields": {
            "values": [
              {
                "name": "companyDomain",
                "stringValue": "viragames"
              }
            ]
          },
          "options": {}
        },
        "id": "a49f7124-71e6-4985-9af0-4dc4af695902",
        "name": "Set Company Domain",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3,
        "position": [
          752,
          -416
        ]
      },
      {
        "parameters": {
          "url": "=https://{{ $json.companyDomain }}.bamboohr.com/api/v1/meta/lists",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBasicAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Accept",
                "value": "application/json"
              }
            ]
          },
          "options": {}
        },
        "id": "0dbe9196-5f97-4c7b-8f89-69b9598c6acb",
        "name": "Get BambooHR Meta Fields",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4,
        "position": [
          1008,
          -416
        ],
        "credentials": {
          "httpBearerAuth": {
            "id": "JNoBFOypI7HysyPY",
            "name": "TeamTailor"
          },
          "httpBasicAuth": {
            "id": "WuZbpCXJaiQvmIxb",
            "name": "BambooHR Basic Auth"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// n8n Code Node: Process Field Discovery (Alternative for Split Items)\n\n/***********************************************************************\n * 1. GET ALL ITEMS (when Split Into Items is ON)\n ***********************************************************************/\n// When \"Split Into Items\" is ON, we need to collect all items\nconst allItems = $input.all();\nconst metaFields = allItems.map(item => item.json);\n\n// The test employee data from the starting node.\nconst employeeData = $(\"Build Employee Payload\").all();\n\n/***********************************************************************\n * 2. VALIDATE THE INPUT DATA STRUCTURE\n ***********************************************************************/\nconsole.log(`Received ${metaFields.length} meta fields from BambooHR`);\n\n/***********************************************************************\n * 3. MAP FIELD NAMES TO IDs\n ***********************************************************************/\nconst fieldMapping = {};\n\nfor (const field of metaFields) {\n  // We only care about fields that can be managed via the API.\n  if (field.manageable !== 'yes') {\n    continue;\n  }\n\n  const id = parseInt(field.fieldId, 10);\n  const alias = (field.alias || '').toLowerCase();\n  const name = (field.name || '').toLowerCase();\n\n  // Use the 'alias' for primary matching when available\n  if (alias) {\n    switch (alias) {\n      case 'department':\n        fieldMapping.department = id;\n        break;\n      case 'division':\n        fieldMapping.division = id;\n        break;\n      case 'jobtitle':\n        fieldMapping.jobTitle = id;\n        break;\n      case 'location':\n        fieldMapping.location = id;\n        break;\n      case 'team':\n        fieldMapping.team = id;\n        break;\n      case 'customteams':\n        // Fallback for custom teams field\n        if (!fieldMapping.team) {\n          fieldMapping.team = id;\n        }\n        break;\n    }\n  }\n  \n  // Secondary check based on name if alias didn't match\n  if (!alias || !fieldMapping.jobTitle) {\n    if (name === 'job title' && !fieldMapping.jobTitle) {\n      fieldMapping.jobTitle = id;\n    }\n  }\n}\n\n/***********************************************************************\n * 4. DEBUG OUTPUT\n ***********************************************************************/\nconsole.log('Discovered field mappings:', JSON.stringify(fieldMapping, null, 2));\n\n// Log which fields we found and which we didn't\nconst expectedFields = ['department', 'division', 'jobTitle'];\nfor (const fieldName of expectedFields) {\n  if (fieldMapping[fieldName]) {\n    console.log(`✓ Found ${fieldName}: fieldId = ${fieldMapping[fieldName]}`);\n  } else {\n    console.warn(`✗ Could not find ${fieldName} field`);\n  }\n}\n\n/***********************************************************************\n * 5. FINAL OUTPUT\n ***********************************************************************/\nreturn [{\n  json: {\n    fieldMapping,\n    employeeData,\n    metaFields\n  }\n}];"
        },
        "id": "fa798b81-afb6-4673-aab0-44aff5b860d1",
        "name": "Process Field Discovery",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1248,
          -416
        ]
      },
      {
        "parameters": {
          "jsCode": "const { fieldMapping, employeeData, metaFields } = $input.all()[0].json;\n\n// Function to find existing options for a field\nfunction getExistingOptions(fieldName) {\n  const fieldId = fieldMapping[fieldName];\n  if (!fieldId) return [];\n  \n  const field = metaFields.find(f => f.fieldId === fieldId);\n  return field ? field.options || [] : [];\n}\n\n// Function to check if option exists\nfunction optionExists(fieldName, optionValue) {\n  const options = getExistingOptions(fieldName);\n  return options.find(option => \n    (option.value || '').toLowerCase() === optionValue.toLowerCase() ||\n    (option.name || '').toLowerCase() === optionValue.toLowerCase()\n  );\n}\n\n// Check required organizational fields\nconst requiredFields = ['department', 'division', 'jobTitle'];\nconst validationResults = {};\nconst missingFields = [];\n\nfor (const fieldName of requiredFields) {\n  const fieldId = fieldMapping[fieldName];\n  const optionValue = employeeData[fieldName];\n  \n  if (!fieldId) {\n    validationResults[fieldName] = { \n      status: 'field_missing', \n      message: `Field ID not found for ${fieldName}` \n    };\n  } else if (!optionValue) {\n    validationResults[fieldName] = { \n      status: 'value_missing', \n      message: `No value provided for ${fieldName}` \n    };\n  } else {\n    const existingOption = optionExists(fieldName, optionValue);\n    if (existingOption) {\n      validationResults[fieldName] = {\n        status: 'exists',\n        option: existingOption,\n        fieldId: fieldId\n      };\n    } else {\n      validationResults[fieldName] = {\n        status: 'needs_creation',\n        value: optionValue,\n        fieldId: fieldId\n      };\n      missingFields.push(fieldName);\n    }\n  }\n}\n\nconsole.log('Validation results:', validationResults);\nconsole.log('Missing fields:', missingFields);\n\nreturn [{\n  json: {\n    validationResults: validationResults,\n    missingFields: missingFields,\n    fieldMapping: fieldMapping,\n    employeeData: employeeData,\n    metaFields: metaFields,\n    needsCreation: missingFields.length > 0\n  }\n}];"
        },
        "id": "7e0a7517-f608-464a-a8a7-c2bbf1699fd4",
        "name": "Validate Meta Field Options",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1456,
          -416
        ]
      },
      {
        "parameters": {
          "conditions": {
            "boolean": [
              {
                "value1": "={{ $json.needsCreation }}",
                "value2": true
              }
            ]
          }
        },
        "id": "64a43947-171f-454b-a0e7-0922e71fc0cb",
        "name": "Need to Create Fields?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 1,
        "position": [
          1728,
          -416
        ]
      },
      {
        "parameters": {
          "jsCode": "const { missingFields, validationResults, metaFields, fieldMapping, employeeData } = $input.all()[0].json;\n\n// Create meta field options for missing fields\nconst creationPromises = [];\n\nfor (const fieldName of missingFields) {\n  const fieldId = validationResults[fieldName].fieldId;\n  const newValue = validationResults[fieldName].value;\n  \n  // Get existing options for the field\n  const field = metaFields.find(f => f.fieldId === fieldId);\n  const existingOptions = field ? field.options || [] : [];\n  \n  // Add new option to existing options - using the correct format that matches Python\n  const updatedOptions = [...existingOptions, { \"value\": newValue }];\n  \n  creationPromises.push({\n    fieldName: fieldName,\n    fieldId: fieldId,\n    newValue: newValue,\n    updatedOptions: updatedOptions\n  });\n}\n\nreturn creationPromises.map(item => ({ json: { ...item, employeeData, fieldMapping } }));"
        },
        "id": "8b31c4e8-ab5b-45f1-b0a0-6cdd45ac0fa5",
        "name": "Prepare Meta Field Creation",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1936,
          -512
        ]
      },
      {
        "parameters": {
          "method": "PUT",
          "url": "=https://{{ $('Set Company Domain').first().json.companyDomain }}.bamboohr.com/api/v1/meta/lists/{{ $json.fieldId }}",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBasicAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ {\"options\": $json.updatedOptions} }}",
          "options": {}
        },
        "id": "aa3e8f49-7f0f-459a-995d-1d6810ec77c9",
        "name": "Create Meta Field Option",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4,
        "position": [
          2160,
          -512
        ],
        "credentials": {
          "httpBasicAuth": {
            "id": "WuZbpCXJaiQvmIxb",
            "name": "BambooHR Basic Auth"
          }
        }
      },
      {
        "parameters": {
          "url": "=https://{{ $('Set Company Domain').first().json.companyDomain }}.bamboohr.com/api/v1/meta/lists",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBasicAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Accept",
                "value": "application/json"
              }
            ]
          },
          "options": {}
        },
        "id": "b123b3de-647c-472f-bea5-7eda00505ca3",
        "name": "Refresh Meta Fields",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4,
        "position": [
          2016,
          -304
        ],
        "credentials": {
          "httpBasicAuth": {
            "id": "WuZbpCXJaiQvmIxb",
            "name": "BambooHR Basic Auth"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "const { json: root } = $('Validate Meta Field Options').first();\n\n// Unwrap employee data\nconst employeeDataArr = root.employeeData;\nconst employeeData = Array.isArray(employeeDataArr)\n  ? (employeeDataArr[0]?.json || {})\n  : employeeDataArr;\n\n// Field mapping / meta-field options\nconst fieldMapping = root.fieldMapping;\nconst allItems      = $input.all();\nconst updatedMetaFields = (allItems.length === 1 && Array.isArray(allItems[0].json))\n  ? allItems[0].json           // full array came in a single item\n  : allItems.map(i => i.json); // split items\n\nfunction getOptionId(fieldName, optionValue) {\n  const fieldId = fieldMapping[fieldName];\n  if (!fieldId) return null;\n\n  const field = updatedMetaFields.find(f => f.fieldId === fieldId);\n  if (!field || !field.options) return null;\n\n  const opt = field.options.find(o =>\n    (o.value || '').toLowerCase() === optionValue.toLowerCase() ||\n    (o.name  || '').toLowerCase() === optionValue.toLowerCase()\n  );\n  return opt?.id ?? null;\n}\n\n// Build enhanced payload with offer data\nconst employeePayload = {\n  firstName: employeeData.firstName,\n  lastName:  employeeData.lastName,\n  workEmail: employeeData.email,\n  hireDate:  employeeData.hireDate,\n  employmentHistoryStatus: employeeData.employmentStatus || 'Full-Time',\n  payType:  'Salary',\n  payPer:   employeeData.payPer || 'Year', // Use dynamic pay period from offer\n  exempt:   employeeData.exempt   || 'Exempt',\n  location: employeeData.location || 'Remote',\n};\n\n// Add salary if available from offer\nif (employeeData.salary) {\n  employeePayload.payRate = employeeData.salary;\n}\n\n// Add phone if available\nif (employeeData.phone) {\n  employeePayload.mobilePhone = employeeData.phone;\n}\n\n// Hybrid organisational fields\n['department', 'division', 'jobTitle'].forEach(field => {\n  if (employeeData[field]) {\n    employeePayload[field] = employeeData[field];\n    const id = getOptionId(field, employeeData[field]);\n    if (id) employeePayload[`${field}Id`] = id;\n  }\n});\n\n// Add custom fields for offer tracking\nif (employeeData.offerId) {\n  employeePayload.customOfferId = employeeData.offerId;\n}\nif (employeeData.offerStatus) {\n  employeePayload.customOfferStatus = employeeData.offerStatus;\n}\n\nconsole.log('Enhanced employee payload:', employeePayload);\n\nreturn [\n  {\n    json: {\n      employeePayload,\n      originalData: employeeData,\n      offerData: {\n        offerId: employeeData.offerId,\n        offerStatus: employeeData.offerStatus,\n        salary: employeeData.salary,\n        hireDate: employeeData.hireDate\n      }\n    }\n  }\n];"
        },
        "id": "e4894b87-ee9f-4ed1-8439-3b7274b8570f",
        "name": "Prepare Employee Data",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2208,
          -304
        ]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://{{ $('Set Company Domain').first().json.companyDomain }}.bamboohr.com/api/v1/employees",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBasicAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ $json.employeePayload }}",
          "options": {}
        },
        "id": "92159ebd-35ae-4929-b460-5cd45c2fb52d",
        "name": "Create Employee",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4,
        "position": [
          2400,
          -304
        ],
        "credentials": {
          "httpBasicAuth": {
            "id": "WuZbpCXJaiQvmIxb",
            "name": "BambooHR Basic Auth"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "const response = $input.all()[0];\nconst employeeData = $('Prepare Employee Data').first().json;\nconst companyDomain = $('Set Company Domain').first().json.companyDomain;\n\n// Extract employee ID from Location header if available\nlet employeeId = null;\nif (response.headers && response.headers.location) {\n  const locationMatch = response.headers.location.match(/\\/employees\\/(\\d+)/);\n  if (locationMatch) {\n    employeeId = parseInt(locationMatch[1]);\n  }\n}\n\nreturn [{\n  json: {\n    success: true,\n    message: \"Employee created successfully with offer data\",\n    employee: {\n      id: employeeId,\n      name: `${employeeData.originalData.firstName} ${employeeData.originalData.lastName}`,\n      email: employeeData.originalData.email,\n      department: employeeData.originalData.department,\n      division: employeeData.originalData.division,\n      jobTitle: employeeData.originalData.jobTitle,\n      hireDate: employeeData.originalData.hireDate,\n      salary: employeeData.originalData.salary\n    },\n    offerData: employeeData.offerData,\n    bambooHrUrl: employeeId ? \n      `https://${companyDomain}.bamboohr.com/employees/${employeeId}` : null,\n    createdAt: new Date().toISOString()\n  }\n}];"
        },
        "id": "10955232-a771-4885-9f4a-27d039834a47",
        "name": "Process Success Response",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2576,
          -304
        ]
      },
      {
        "parameters": {
          "select": "channel",
          "channelId": {
            "__rl": true,
            "value": "C097URH3622",
            "mode": "list",
            "cachedResultName": "onboarding"
          },
          "text": "={{ `🎉 *New Employee Created Successfully!*\n\n*Name:* ${$json[\"employee\"][\"name\"]}\n*Email:* ${$json[\"employee\"][\"email\"]}\n*Department:* ${$json[\"employee\"][\"department\"]}\n*Job Title:* ${$json[\"employee\"][\"jobTitle\"]}\n*Hire Date:* ${$json[\"employee\"][\"hireDate\"]}\n*Salary:* ${$json[\"employee\"][\"salary\"] ? '$' + $json[\"employee\"][\"salary\"] + ' USD/year' : 'Not specified'}\n\n*Offer Data:*\n• Offer ID: ${$json[\"offerData\"][\"offerId\"] || 'N/A'}\n• Offer Status: ${$json[\"offerData\"][\"offerStatus\"] || 'N/A'}\n\n*Created At:* ${new Date($json[\"createdAt\"]).toLocaleString(\"en-GB\", { timeZone: \"UTC\" })}\n\nStatus: ${$json[\"message\"]}\n` }}",
          "otherOptions": {
            "includeLinkToWorkflow": false
          }
        },
        "type": "n8n-nodes-base.slack",
        "typeVersion": 2.3,
        "position": [
          2752,
          -304
        ],
        "id": "d7dcb544-253b-464e-84be-2f9a86154572",
        "name": "Send Notification – Employee Created",
        "webhookId": "7691f4d7-a798-4508-b88d-cd3ad73230ed",
        "credentials": {
          "slackApi": {
            "id": "h4hYe6hY0YHsd0no",
            "name": "Vira Bot"
          }
        }
      },
      {
        "parameters": {
          "content": "## Production",
          "height": 800,
          "width": 3936
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -976,
          -640
        ],
        "typeVersion": 1,
        "id": "088d79a9-ff38-4d6f-91d9-280e2fddc23a",
        "name": "Sticky Note"
      }
    ],
    "connections": {
      "Webhook": {
        "main": [
          [
            {
              "node": "Hired",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Hired": {
        "main": [
          [
            {
              "node": "Fetch All Job Offers (Paginated)",
              "type": "main",
              "index": 0
            },
            {
              "node": "HTTP Request to TeamTailor Show the Job Requisition",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "No Operation, do nothing",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch All Job Offers (Paginated)": {
        "main": [
          [
            {
              "node": "Process Job Offers",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "convert to json object": {
        "main": [
          [
            {
              "node": "Build Employee Payload",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "HTTP Request": {
        "main": [
          [
            {
              "node": "convert to json object",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "convert to json object1": {
        "main": [
          [
            {
              "node": "HTTP Request",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Employee Payload": {
        "main": [
          [
            {
              "node": "Set Company Domain",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "HTTP Request to TeamTailor Show the Job Requisition": {
        "main": [
          [
            {
              "node": "convert to json object1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Set Company Domain": {
        "main": [
          [
            {
              "node": "Get BambooHR Meta Fields",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get BambooHR Meta Fields": {
        "main": [
          [
            {
              "node": "Process Field Discovery",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Process Field Discovery": {
        "main": [
          [
            {
              "node": "Validate Meta Field Options",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Validate Meta Field Options": {
        "main": [
          [
            {
              "node": "Need to Create Fields?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Need to Create Fields?": {
        "main": [
          [
            {
              "node": "Prepare Meta Field Creation",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Refresh Meta Fields",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare Meta Field Creation": {
        "main": [
          [
            {
              "node": "Create Meta Field Option",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Create Meta Field Option": {
        "main": [
          [
            {
              "node": "Refresh Meta Fields",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Refresh Meta Fields": {
        "main": [
          [
            {
              "node": "Prepare Employee Data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare Employee Data": {
        "main": [
          [
            {
              "node": "Create Employee",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Create Employee": {
        "main": [
          [
            {
              "node": "Process Success Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Process Success Response": {
        "main": [
          [
            {
              "node": "Send Notification – Employee Created",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "pinData": {},
    "meta": {
      "templateCredsSetupCompleted": true,
      "instanceId": "db8c34fa8115e7968d24f8e10f4a110dda7aba2143d2fb70a8ce47f420de93d6"
    }
  }